[
["interactive-choropleth-map.html", "2 Interactive Choropleth Map 2.1 Shapefiles 2.2 Data 2.3 Maps 2.4 Map 1: Quantiles with diverging Red-Blue Scale", " 2 Interactive Choropleth Map This chapter has an example of creating an interactive leaflet map using 2016 county-level election results. I left it mostly unchanged from what you did in 380 so you’ll recognize it and can see how bookdown uses RMD files you’ve used in the past and just puts them together as a book. library(dplyr) ## ## Attaching package: &#39;dplyr&#39; ## The following objects are masked from &#39;package:stats&#39;: ## ## filter, lag ## The following objects are masked from &#39;package:base&#39;: ## ## intersect, setdiff, setequal, union library(leaflet) library(tigris) ## To enable ## caching of data, set `options(tigris_use_cache = TRUE)` in your R script or .Rprofile. options(tigris_use_cache = TRUE) This assignment builds on what you did in HW-02-12 and what we discussed in class Tuesday (Feb. 12). 2.1 Shapefiles You can use the same packages and GIS shapefiles as you did in HW-02-12. #load GIS shapefiles using tigris package functions statesGIS &lt;- states(cb = TRUE,resolution = &quot;20m&quot;) countiesGIS &lt;- counties(cb = TRUE,resolution = &quot;20m&quot;) ## Drop Puerto Rico (since we don&#39;t have election data for it) countiesGIS &lt;- subset(countiesGIS,STATEFP != &quot;72&quot;) statesGIS &lt;- subset(statesGIS,STATEFP != &quot;72&quot;) ## Let&#39;s also drop Alaska and Hawaii countiesGIS &lt;- subset(countiesGIS,!(STATEFP %in% c(&quot;02&quot;,&quot;15&quot;))) statesGIS &lt;- subset(statesGIS,!(STATEFP %in% c(&quot;02&quot;,&quot;15&quot;))) ## Keep only the columns we need (GEOID is 5-character FIPS) ## This part isn&#39;t necessary. It just makes the resulting file a little smaller, so the final map will load a little quicker. I won&#39;t bother for statesGIS because it&#39;s small already countiesGIS &lt;- countiesGIS[,(names(countiesGIS) %in% c(&quot;GEOID&quot;,&quot;NAME&quot;))] 2.2 Data For this assignment you can use data for the 2016 presidential election. The website we used for the 2004, 2008, and 2012 election results for HW-02-12 linked to a github page with data for the 2016 election. The site has Python code to scrape the data from a website (which we’re not going to look at but some of you might find interesting at some point). We’ll use the csv file they named 2016_US_County_Level_Presidential_Results.csv. When you click on the link to that file you see it displayed in GitHub. If you click on the “Raw” button near the top of the data it opens up the actual csv file, i.e., a page with values separated by commas. Copy the URL of this page. Paste the URL as the file name in the read.csv() function. Then manipulate the data so that it can be used to make the maps. Make sure to fix the FIPS code for Oglala Lakota, SD by changing FIPS code 46113 in the 2016 voting data to FIPS code 46102 before merging with the county shape file (countiesGIS). To make sure you understand how this works, here is an example using the 2012 data from HW-02-12. The URL for that data is (http://faculty.baruch.cuny.edu/geoportal/data/county_election/elpo12p010g.csv). You could read this data using the command dta2012 &lt;- read.csv(\"http://faculty.baruch.cuny.edu/geoportal/data/county_election/elpo12p010g.csv\") instead of downloading the file. ## Read the data from URL # dta2016 &lt;- read.csv(&quot;put URL here&quot;) # Write rest of code to manipulate data and merge it with countiesGIS ## Read the data from URL dta2016 &lt;- read.csv(&quot;https://raw.githubusercontent.com/tonmcg/US_County_Level_Election_Results_08-16/master/2016_US_County_Level_Presidential_Results.csv&quot;) ## Remember to examine the column names colnames(dta2016) ## [1] &quot;X&quot; &quot;votes_dem&quot; &quot;votes_gop&quot; &quot;total_votes&quot; ## [5] &quot;per_dem&quot; &quot;per_gop&quot; &quot;diff&quot; &quot;per_point_diff&quot; ## [9] &quot;state_abbr&quot; &quot;county_name&quot; &quot;combined_fips&quot; dta2016$Winner2016 &lt;- ifelse(dta2016$votes_gop &gt; dta2016$votes_dem,&quot;Trump&quot;,&quot;Clinton&quot;) colnames(dta2016)[colnames(dta2016)==&quot;combined_fips&quot;] &lt;- &quot;FIPS&quot; colnames(dta2016)[colnames(dta2016)==&quot;state_abbr&quot;] &lt;- &quot;STATE&quot; colnames(dta2016)[colnames(dta2016)==&quot;per_dem&quot;] &lt;- &quot;PctDem2016&quot; colnames(dta2016)[colnames(dta2016)==&quot;per_gop&quot;] &lt;- &quot;PctRep2016&quot; colnames(dta2016)[colnames(dta2016)==&quot;total_votes&quot;] &lt;- &quot;TotalVote2016&quot; dta2016$PctWinner2016 &lt;- pmax(dta2016$PctDem2016,dta2016$PctRep2016) dta2016$FontColorWinner2016 &lt;- ifelse(dta2016$votes_gop &gt; dta2016$votes_dem,&quot;red&quot;, ifelse(dta2016$votes_gop &lt; dta2016$votes_dem,&quot;blue&quot;, &quot;purple&quot;)) dta2016[dta2016$FIPS==46113,] ## X votes_dem votes_gop TotalVote2016 PctDem2016 PctRep2016 diff ## 2412 2411 2504 241 2896 0.8646409 0.08321823 2,263 ## per_point_diff STATE county_name FIPS Winner2016 PctWinner2016 ## 2412 78.14% SD Oglala County 46113 Clinton 0.8646409 ## FontColorWinner2016 ## 2412 blue dta2016[dta2016$FIPS==46102,] ## [1] X votes_dem votes_gop ## [4] TotalVote2016 PctDem2016 PctRep2016 ## [7] diff per_point_diff STATE ## [10] county_name FIPS Winner2016 ## [13] PctWinner2016 FontColorWinner2016 ## &lt;0 rows&gt; (or 0-length row.names) dta2016$FIPS &lt;- ifelse(dta2016$FIPS==46113,46102,dta2016$FIPS) dta2016[dta2016$FIPS==46113,] ## [1] X votes_dem votes_gop ## [4] TotalVote2016 PctDem2016 PctRep2016 ## [7] diff per_point_diff STATE ## [10] county_name FIPS Winner2016 ## [13] PctWinner2016 FontColorWinner2016 ## &lt;0 rows&gt; (or 0-length row.names) dta2016[dta2016$FIPS==46102,] ## X votes_dem votes_gop TotalVote2016 PctDem2016 PctRep2016 diff ## 2412 2411 2504 241 2896 0.8646409 0.08321823 2,263 ## per_point_diff STATE county_name FIPS Winner2016 PctWinner2016 ## 2412 78.14% SD Oglala County 46102 Clinton 0.8646409 ## FontColorWinner2016 ## 2412 blue dtaAllYears &lt;- select(dta2016,&quot;FIPS&quot;,&quot;STATE&quot;,&quot;PctDem2016&quot;, &quot;PctRep2016&quot;,&quot;PctWinner2016&quot;,&quot;TotalVote2016&quot;, &quot;Winner2016&quot;,&quot;FontColorWinner2016&quot;) #Create GEOID string from int FIPS dtaAllYears$GEOID &lt;- sprintf(&quot;%05d&quot;, dtaAllYears$FIPS) ## Merge mydata with shapefile data county_dta &lt;- geo_join(countiesGIS, dtaAllYears,&quot;GEOID&quot;,&quot;GEOID&quot;) ## Warning: `group_by_()` is deprecated as of dplyr 0.7.0. ## Please use `group_by()` instead. ## See vignette(&#39;programming&#39;) for more help ## This warning is displayed once every 8 hours. ## Call `lifecycle::last_warnings()` to see where this warning was generated. ## MODIFY/ADD TO THIS CODE to include 2004 just like 2008 and 2012: popup_dta &lt;- paste0(&quot;&lt;strong&gt;&quot;,county_dta$NAME ,&quot;, &quot;,county_dta$STATE,&quot; (&quot;,county_dta$GEOID,&quot;)&lt;/strong&gt;&quot;, &quot;&lt;br&gt;&lt;font color=&#39;&quot;,county_dta$FontColorWinner2012,&quot;&#39;&gt;2012: &quot;, format(county_dta$Winner2016,big.mark=&quot;,&quot;, trim=TRUE), &quot; (&quot;, format(county_dta$PctWinner2016,digits=3, trim=TRUE), &quot;%)&lt;/font&gt;&quot; ) labels &lt;- popup_dta %&gt;% lapply(htmltools::HTML) 2.3 Maps Each map should be what we called “Popup on mouseover” map in HW-02-12 (i.e. one layer with a popup that opens without the need to click). Each map should be a… choropleth map of Percent Voting for the Democrat in 2016 (e.g., PctDem2016) with a… popup displaying County name, ST (e.g., “Outagamie, WI”), the name of the winner (Trump or Clinton), and the percent voting for the winner. The only difference between the maps should be the color function (and the legend and legend label).Make one map per code chunk below. Each code chunk should have the following: Color palette function (i.e., pal &lt;- ...). Before this function we’ll include a line pal &lt;- NULL to make sure the previous palette isn’t being re-used. Variable with the legend title Code to make the map 2.4 Map 1: Quantiles with diverging Red-Blue Scale This map is identical to HW-02-12 so I’ll copy/paste the code for you. It uses the “RdBu” palette. Technically this is called a “diverging palette”. See this website for details about RColorBrewer: https://moderndata.plot.ly/create-colorful-graphs-in-r-with-rcolorbrewer-and-plotly/ #Make Color Palette pal &lt;- NULL pal &lt;- colorQuantile(&quot;RdBu&quot;, NULL, n = 9) #Legend title sLegendTitle &lt;- &quot;Percentiles: % Vote for Dem&quot; ## Map with state borders and popup if click leaflet(data= county_dta) %&gt;% addTiles() %&gt;% setView(-97, 39, zoom = 4) %&gt;% addPolygons( fillColor = ~pal(county_dta$PctDem2016), weight = 1, opacity = 1, color = &quot;white&quot;, dashArray = &quot;3&quot;, fillOpacity = 0.7, highlight = highlightOptions( weight = 5, color = &quot;#666&quot;, dashArray = &quot;&quot;, fillOpacity = 0.7, bringToFront = TRUE), label = labels, labelOptions = labelOptions( style = list(&quot;font-weight&quot; = &quot;normal&quot;, padding = &quot;3px 8px&quot;), textsize = &quot;15px&quot;, direction = &quot;auto&quot;)) %&gt;% addPolygons(data = statesGIS,fill = FALSE,color=&quot;yellow&quot;,weight = 1) %&gt;% addLegend(pal = pal,values = ~county_dta$PctDem2016, opacity = 0.7, title = sLegendTitle,position = &quot;bottomright&quot;) ## Warning: sf layer has inconsistent datum (+proj=longlat +datum=NAD83 +no_defs). ## Need &#39;+proj=longlat +datum=WGS84&#39; ## Warning: sf layer has inconsistent datum (+proj=longlat +datum=NAD83 +no_defs). ## Need &#39;+proj=longlat +datum=WGS84&#39; small change "]
]
